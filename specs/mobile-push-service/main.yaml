Parameters:
  Environment:
    Type: String
  TemplateUrlPrefix:
    Type: String
  LambdaPrefix:
    Type: String
  LayerPrefix:
    Type: String
  ArtifactsBucket:
    Type: String
  CompanyName:
    Type: String
  ServiceName:
    Type: String
Resources:
  LambdaspushnotificationingressLambdaSqsQueueNameE1050643:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Value:
        Fn::GetAtt:
          - pushnotificationingressAPPQUEUENAMEMOBILEPUSHINGRESSSqsLambdaBindingSqsQueueEF5AAA04
          - QueueName
      Name:
        Fn::Join:
          - ""
          - - /infra/
            - Ref: Environment
            - /resources/queues/mobile-push-notification-ingress
  LambdaspushnotificationworkerLambdaSqsQueueName8B6164DF:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Value:
        Fn::GetAtt:
          - pushnotificationworkerAPPQUEUENAMEMOBILEPUSHWORKERSqsLambdaBindingSqsQueue5E7153C3
          - QueueName
      Name:
        Fn::Join:
          - ""
          - - /infra/
            - Ref: Environment
            - /resources/queues/mobile-push-notification-worker
  mobilepushservicecloudcommonLayerF07F50E1:
    Type: AWS::Lambda::LayerVersion
    Properties:
      Content:
        S3Bucket:
          Ref: ArtifactsBucket
        S3Key:
          Fn::Join:
            - ""
            - - Ref: LayerPrefix
              - /cloud-common.zip
      LayerName:
        Fn::Join:
          - ""
          - - Ref: Environment
            - -mobile-push-service-cloud-common
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  mobilepushservicepushnotificationingressFuncServiceRole4D5A288D:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonSQSFullAccess
        - arn:aws:iam::aws:policy/AmazonSNSFullAccess
  mobilepushservicepushnotificationingressFuncServiceRoleDefaultPolicyE1D0830F:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - sqs:ReceiveMessage
              - sqs:ChangeMessageVisibility
              - sqs:GetQueueUrl
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - pushnotificationingressAPPQUEUENAMEMOBILEPUSHINGRESSSqsLambdaBindingSqsQueueEF5AAA04
                - Arn
        Version: "2012-10-17"
      PolicyName: mobilepushservicepushnotificationingressFuncServiceRoleDefaultPolicyE1D0830F
      Roles:
        - Ref: mobilepushservicepushnotificationingressFuncServiceRole4D5A288D
  mobilepushservicepushnotificationingressFunc67E70310:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: ArtifactsBucket
        S3Key:
          Fn::Join:
            - ""
            - - Ref: LambdaPrefix
              - /push_notification_ingress.zip
      Role:
        Fn::GetAtt:
          - mobilepushservicepushnotificationingressFuncServiceRole4D5A288D
          - Arn
      Environment:
        Variables:
          ENV:
            Ref: Environment
      FunctionName:
        Fn::Join:
          - ""
          - - Ref: Environment
            - -mobile-push-service-push_notification_ingress
      Handler: app.handler.handler
      Layers:
        - Ref: mobilepushservicecloudcommonLayerF07F50E1
      Runtime: python3.8
      Timeout: 30
    DependsOn:
      - mobilepushservicepushnotificationingressFuncServiceRoleDefaultPolicyE1D0830F
      - mobilepushservicepushnotificationingressFuncServiceRole4D5A288D
  mobilepushservicepushnotificationingressFuncInvokeServicePrincipalsqsamazonawscomD7B65A92:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - mobilepushservicepushnotificationingressFunc67E70310
          - Arn
      Principal: sqs.amazonaws.com
  mobilepushservicepushnotificationingressFuncpushnotificationingressAPPQUEUENAMEMOBILEPUSHINGRESSSqsLambdaBindingSqsEventSourceD7B093D0:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      FunctionName:
        Ref: mobilepushservicepushnotificationingressFunc67E70310
      BatchSize: 1
      EventSourceArn:
        Fn::GetAtt:
          - pushnotificationingressAPPQUEUENAMEMOBILEPUSHINGRESSSqsLambdaBindingSqsQueueEF5AAA04
          - Arn
  pushnotificationingressAPPQUEUENAMEMOBILEPUSHINGRESSSqsLambdaBindingSqsQueueDLQueue02435416:
    Type: AWS::SQS::Queue
    Properties:
      FifoQueue: true
      MessageRetentionPeriod: 345600
      QueueName:
        Fn::Join:
          - ""
          - - dlq-
            - Ref: Environment
            - -mobile-push-service-mobile-push-notification-ingress.fifo
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  pushnotificationingressAPPQUEUENAMEMOBILEPUSHINGRESSSqsLambdaBindingSqsQueueDLQAlarm1013BB16:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      AlarmActions:
        - Fn::Join:
            - ""
            - - "arn:aws:sns:us-west-2:953022346399:"
              - Ref: Environment
              - "-"
              - Ref: Environment
              - -errors-notifications-alerts
      AlarmDescription:
        Fn::Join:
          - ""
          - - SNS Alarm for dlq-
            - Ref: Environment
            - -mobile-push-service-mobile-push-notification-ingress DLQ Message count
      AlarmName:
        Fn::Join:
          - ""
          - - dlq-
            - Ref: Environment
            - -mobile-push-service-mobile-push-notification-ingressAlarm
      Metrics:
        - Id: m1
          Label: Number of Messages in DLQ
          MetricStat:
            Metric:
              Dimensions:
                - Name: QueueName
                  Value:
                    Fn::GetAtt:
                      - pushnotificationingressAPPQUEUENAMEMOBILEPUSHINGRESSSqsLambdaBindingSqsQueueDLQueue02435416
                      - QueueName
              MetricName: NumberOfMessagesSent
              Namespace: AWS/SQS
            Period: 300
            Stat: Sum
          ReturnData: true
      Threshold: 1
  pushnotificationingressAPPQUEUENAMEMOBILEPUSHINGRESSSqsLambdaBindingSqsQueueEF5AAA04:
    Type: AWS::SQS::Queue
    Properties:
      FifoQueue: true
      QueueName:
        Fn::Join:
          - ""
          - - Ref: Environment
            - -mobile-push-service-mobile-push-notification-ingress.fifo
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
            - pushnotificationingressAPPQUEUENAMEMOBILEPUSHINGRESSSqsLambdaBindingSqsQueueDLQueue02435416
            - Arn
        maxReceiveCount: 10
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  pushnotificationingressErrorAlarm73D9914C:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      AlarmActions:
        - Fn::Join:
            - ""
            - - "arn:aws:sns:us-west-2:953022346399:"
              - Ref: Environment
              - "-"
              - Ref: Environment
              - -errors-notifications-alerts
      AlarmDescription: SNS Alarm for push_notification_ingress lambda errors
      AlarmName:
        Fn::Join:
          - ""
          - - Ref: Environment
            - -mobile-push-service-push_notification_ingressErrorAlarm
      Dimensions:
        - Name: FunctionName
          Value:
            Ref: mobilepushservicepushnotificationingressFunc67E70310
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: 300
      Statistic: Sum
      Threshold: 1
  pushnotificationingressThrottleAlarm012CA647:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      AlarmActions:
        - Fn::Join:
            - ""
            - - "arn:aws:sns:us-west-2:953022346399:"
              - Ref: Environment
              - "-"
              - Ref: Environment
              - -errors-notifications-alerts
      AlarmDescription: SNS Alarm for push_notification_ingress lambda throttling
      AlarmName:
        Fn::Join:
          - ""
          - - Ref: Environment
            - -mobile-push-service-push_notification_ingressThrottleAlarm
      Dimensions:
        - Name: FunctionName
          Value:
            Ref: mobilepushservicepushnotificationingressFunc67E70310
      MetricName: Throttles
      Namespace: AWS/Lambda
      Period: 300
      Statistic: Sum
      Threshold: 1
  mobilepushservicepushnotificationschedulerFuncServiceRole0E49DE9E:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonSQSFullAccess
        - arn:aws:iam::aws:policy/AmazonSNSFullAccess
  mobilepushservicepushnotificationschedulerFunc26266313:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: ArtifactsBucket
        S3Key:
          Fn::Join:
            - ""
            - - Ref: LambdaPrefix
              - /push_notification_scheduler.zip
      Role:
        Fn::GetAtt:
          - mobilepushservicepushnotificationschedulerFuncServiceRole0E49DE9E
          - Arn
      Environment:
        Variables:
          ENV:
            Ref: Environment
      FunctionName:
        Fn::Join:
          - ""
          - - Ref: Environment
            - -mobile-push-service-push_notification_scheduler
      Handler: app.handler.handler
      Layers:
        - Ref: mobilepushservicecloudcommonLayerF07F50E1
      Runtime: python3.8
      Timeout: 30
    DependsOn:
      - mobilepushservicepushnotificationschedulerFuncServiceRole0E49DE9E
  pushnotificationschedulerCloudWatchRule6CA6DE1E:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: cron(0/60 * * * ? *)
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - mobilepushservicepushnotificationschedulerFunc26266313
              - Arn
          Id: Target0
  pushnotificationschedulerCloudWatchRuleAllowEventRulemobilepushservicemobilepushservicepushnotificationschedulerFuncC7D6A4154F5BACF9:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - mobilepushservicepushnotificationschedulerFunc26266313
          - Arn
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
          - pushnotificationschedulerCloudWatchRule6CA6DE1E
          - Arn
  pushnotificationschedulerErrorAlarmA64B299A:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      AlarmActions:
        - Fn::Join:
            - ""
            - - "arn:aws:sns:us-west-2:953022346399:"
              - Ref: Environment
              - "-"
              - Ref: Environment
              - -errors-notifications-alerts
      AlarmDescription: SNS Alarm for push_notification_scheduler lambda errors
      AlarmName:
        Fn::Join:
          - ""
          - - Ref: Environment
            - -mobile-push-service-push_notification_schedulerErrorAlarm
      Dimensions:
        - Name: FunctionName
          Value:
            Ref: mobilepushservicepushnotificationschedulerFunc26266313
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: 300
      Statistic: Sum
      Threshold: 1
  pushnotificationschedulerThrottleAlarmACB394DB:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      AlarmActions:
        - Fn::Join:
            - ""
            - - "arn:aws:sns:us-west-2:953022346399:"
              - Ref: Environment
              - "-"
              - Ref: Environment
              - -errors-notifications-alerts
      AlarmDescription: SNS Alarm for push_notification_scheduler lambda throttling
      AlarmName:
        Fn::Join:
          - ""
          - - Ref: Environment
            - -mobile-push-service-push_notification_schedulerThrottleAlarm
      Dimensions:
        - Name: FunctionName
          Value:
            Ref: mobilepushservicepushnotificationschedulerFunc26266313
      MetricName: Throttles
      Namespace: AWS/Lambda
      Period: 300
      Statistic: Sum
      Threshold: 1
  mobilepushservicepushnotificationworkerFuncServiceRole01D76E88:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonSQSFullAccess
        - arn:aws:iam::aws:policy/AmazonSNSFullAccess
  mobilepushservicepushnotificationworkerFuncServiceRoleDefaultPolicy5FBBDAEC:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - sqs:ReceiveMessage
              - sqs:ChangeMessageVisibility
              - sqs:GetQueueUrl
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - pushnotificationworkerAPPQUEUENAMEMOBILEPUSHWORKERSqsLambdaBindingSqsQueue5E7153C3
                - Arn
        Version: "2012-10-17"
      PolicyName: mobilepushservicepushnotificationworkerFuncServiceRoleDefaultPolicy5FBBDAEC
      Roles:
        - Ref: mobilepushservicepushnotificationworkerFuncServiceRole01D76E88
  mobilepushservicepushnotificationworkerFuncCC541532:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: ArtifactsBucket
        S3Key:
          Fn::Join:
            - ""
            - - Ref: LambdaPrefix
              - /push_notification_worker.zip
      Role:
        Fn::GetAtt:
          - mobilepushservicepushnotificationworkerFuncServiceRole01D76E88
          - Arn
      Environment:
        Variables:
          ENV:
            Ref: Environment
      FunctionName:
        Fn::Join:
          - ""
          - - Ref: Environment
            - -mobile-push-service-push_notification_worker
      Handler: app.handler.handler
      Layers:
        - Ref: mobilepushservicecloudcommonLayerF07F50E1
      Runtime: python3.8
      Timeout: 30
    DependsOn:
      - mobilepushservicepushnotificationworkerFuncServiceRoleDefaultPolicy5FBBDAEC
      - mobilepushservicepushnotificationworkerFuncServiceRole01D76E88
  mobilepushservicepushnotificationworkerFuncInvokeServicePrincipalsqsamazonawscom791FB3B2:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - mobilepushservicepushnotificationworkerFuncCC541532
          - Arn
      Principal: sqs.amazonaws.com
  mobilepushservicepushnotificationworkerFuncpushnotificationworkerAPPQUEUENAMEMOBILEPUSHWORKERSqsLambdaBindingSqsEventSource084B86D0:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      FunctionName:
        Ref: mobilepushservicepushnotificationworkerFuncCC541532
      BatchSize: 1
      EventSourceArn:
        Fn::GetAtt:
          - pushnotificationworkerAPPQUEUENAMEMOBILEPUSHWORKERSqsLambdaBindingSqsQueue5E7153C3
          - Arn
  pushnotificationworkerAPPQUEUENAMEMOBILEPUSHWORKERSqsLambdaBindingSqsQueueDLQueue9E8DCEF3:
    Type: AWS::SQS::Queue
    Properties:
      FifoQueue: true
      MessageRetentionPeriod: 345600
      QueueName:
        Fn::Join:
          - ""
          - - dlq-
            - Ref: Environment
            - -mobile-push-service-mobile-push-notification-worker.fifo
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  pushnotificationworkerAPPQUEUENAMEMOBILEPUSHWORKERSqsLambdaBindingSqsQueueDLQAlarmBC0F4680:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      AlarmActions:
        - Fn::Join:
            - ""
            - - "arn:aws:sns:us-west-2:953022346399:"
              - Ref: Environment
              - "-"
              - Ref: Environment
              - -errors-notifications-alerts
      AlarmDescription:
        Fn::Join:
          - ""
          - - SNS Alarm for dlq-
            - Ref: Environment
            - -mobile-push-service-mobile-push-notification-worker DLQ Message count
      AlarmName:
        Fn::Join:
          - ""
          - - dlq-
            - Ref: Environment
            - -mobile-push-service-mobile-push-notification-workerAlarm
      Metrics:
        - Id: m1
          Label: Number of Messages in DLQ
          MetricStat:
            Metric:
              Dimensions:
                - Name: QueueName
                  Value:
                    Fn::GetAtt:
                      - pushnotificationworkerAPPQUEUENAMEMOBILEPUSHWORKERSqsLambdaBindingSqsQueueDLQueue9E8DCEF3
                      - QueueName
              MetricName: NumberOfMessagesSent
              Namespace: AWS/SQS
            Period: 300
            Stat: Sum
          ReturnData: true
      Threshold: 1
  pushnotificationworkerAPPQUEUENAMEMOBILEPUSHWORKERSqsLambdaBindingSqsQueue5E7153C3:
    Type: AWS::SQS::Queue
    Properties:
      FifoQueue: true
      QueueName:
        Fn::Join:
          - ""
          - - Ref: Environment
            - -mobile-push-service-mobile-push-notification-worker.fifo
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
            - pushnotificationworkerAPPQUEUENAMEMOBILEPUSHWORKERSqsLambdaBindingSqsQueueDLQueue9E8DCEF3
            - Arn
        maxReceiveCount: 10
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  pushnotificationworkerErrorAlarm7C75E595:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      AlarmActions:
        - Fn::Join:
            - ""
            - - "arn:aws:sns:us-west-2:953022346399:"
              - Ref: Environment
              - "-"
              - Ref: Environment
              - -errors-notifications-alerts
      AlarmDescription: SNS Alarm for push_notification_worker lambda errors
      AlarmName:
        Fn::Join:
          - ""
          - - Ref: Environment
            - -mobile-push-service-push_notification_workerErrorAlarm
      Dimensions:
        - Name: FunctionName
          Value:
            Ref: mobilepushservicepushnotificationworkerFuncCC541532
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: 300
      Statistic: Sum
      Threshold: 1
  pushnotificationworkerThrottleAlarm2794441E:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      AlarmActions:
        - Fn::Join:
            - ""
            - - "arn:aws:sns:us-west-2:953022346399:"
              - Ref: Environment
              - "-"
              - Ref: Environment
              - -errors-notifications-alerts
      AlarmDescription: SNS Alarm for push_notification_worker lambda throttling
      AlarmName:
        Fn::Join:
          - ""
          - - Ref: Environment
            - -mobile-push-service-push_notification_workerThrottleAlarm
      Dimensions:
        - Name: FunctionName
          Value:
            Ref: mobilepushservicepushnotificationworkerFuncCC541532
      MetricName: Throttles
      Namespace: AWS/Lambda
      Period: 300
      Statistic: Sum
      Threshold: 1

